<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub Profile Views Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Bebas+Neue&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #070b13;
      --surface:  #0c1422;
      --border:   #162035;
      --accent:   #38bdf8;
      --accent2:  #0ea5e9;
      --text:     #cbd5e1;
      --muted:    #334155;
      --dim:      #1e3050;
      --green:    #4ade80;
      --purple:   #818cf8;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'IBM Plex Mono', monospace;
      min-height: 100vh;
    }

    /* ── scrollbar ── */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ── header ── */
    header {
      border-bottom: 1px solid var(--border);
      padding: 16px 28px;
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .logo { font-family: 'Bebas Neue', cursive; font-size: 22px; letter-spacing: 3px; }
    .logo span { color: var(--accent); }

    .live-badge {
      display: flex; align-items: center; gap: 6px;
      background: rgba(56,189,248,.07);
      border: 1px solid rgba(56,189,248,.15);
      border-radius: 20px; padding: 3px 12px;
      font-size: 11px; color: var(--accent);
    }

    .pulse-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--accent); position: relative;
    }
    .pulse-dot.active::before {
      content: '';
      position: absolute; inset: -3px; border-radius: 50%;
      background: var(--accent); opacity: 0.4;
      animation: ping 1.2s ease-out infinite;
    }

    @keyframes ping {
      0%   { transform: scale(1); opacity: .5; }
      100% { transform: scale(2.8); opacity: 0; }
    }

    /* ── main ── */
    main { max-width: 1100px; margin: 0 auto; padding: 28px 24px; }

    /* ── search bar ── */
    .search-row { display: flex; gap: 10px; margin-bottom: 32px; }
    .search-wrap { flex: 1; position: relative; }
    .search-prefix {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--dim); font-size: 12px; pointer-events: none; user-select: none;
    }

    input[type=text] {
      width: 100%; padding: 10px 16px 10px 116px;
      background: var(--surface); border: 1px solid var(--border);
      color: #e2e8f0; border-radius: 10px;
      font-family: 'IBM Plex Mono', monospace; font-size: 13px;
      outline: none; transition: border .2s;
    }
    input[type=text]:focus { border-color: rgba(56,189,248,.5); }

    .btn {
      cursor: pointer; border: none; border-radius: 8px;
      font-family: 'IBM Plex Mono', monospace; font-size: 11px;
      padding: 8px 16px; transition: all .2s;
    }
    .btn-primary { background: rgba(56,189,248,.1); color: var(--accent); border: 1px solid rgba(56,189,248,.2); }
    .btn-primary:hover { background: rgba(56,189,248,.2); }
    .btn-lg { padding: 10px 28px; font-size: 13px; border-radius: 10px; white-space: nowrap; }
    .btn-ghost { background: var(--surface); color: var(--muted); border: 1px solid var(--border); }
    .btn-ghost:hover { border-color: #243050; color: #94a3b8; }

    /* ── empty state ── */
    #empty { text-align: center; padding: 100px 0; }
    .empty-big { font-family: 'Bebas Neue', cursive; font-size: 72px; letter-spacing: 5px; line-height: 1; }

    /* ── window buttons ── */
    .win-row {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
    }
    .win-label { font-size: 10px; color: var(--dim); letter-spacing: .12em; }
    .win-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

    .wbtn {
      cursor: pointer; border-radius: 8px;
      font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 600;
      padding: 7px 14px; transition: all .2s; border: 1px solid transparent;
    }
    .wbtn.on  { background: var(--accent); color: #060c18; }
    .wbtn.off { background: transparent; color: var(--muted); border-color: var(--border); }
    .wbtn.off:hover { border-color: var(--accent); color: var(--accent); }

    /* ── card ── */
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    }

    /* ── stat grid ── */
    .stat-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 14px; margin-bottom: 18px;
    }
    @media (max-width: 700px) { .stat-grid { grid-template-columns: repeat(2,1fr); } }

    .stat-card { padding: 18px 20px; }
    .stat-label { font-size: 9px; color: var(--dim); letter-spacing: .12em; margin-bottom: 8px; }
    .stat-val {
      font-family: 'Bebas Neue', cursive; font-size: 38px; color: #f1f5f9;
      line-height: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .stat-val.small { font-size: 20px; }

    /* ── two-col ── */
    .two-col { display: grid; grid-template-columns: 1fr 270px; gap: 16px; margin-bottom: 16px; }
    @media (max-width: 800px) { .two-col { grid-template-columns: 1fr; } }

    /* ── chart ── */
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .chart-title-label { font-size: 9px; color: var(--dim); letter-spacing: .12em; }
    .chart-subtitle { font-size: 11px; color: var(--muted); margin-top: 3px; }
    .chart-window-label { font-family: 'Bebas Neue', cursive; font-size: 28px; color: var(--accent); letter-spacing: 2px; }

    .bar-chart { display: flex; align-items: flex-end; gap: 3px; height: 80px; margin-top: 8px; }
    .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 0; }
    .bar-fill { width: 100%; border-radius: 3px 3px 0 0; transition: height .5s cubic-bezier(.4,0,.2,1); }
    .bar-lbl { font-size: 8px; color: var(--dim); white-space: nowrap; overflow: hidden; max-width: 100%; text-align: center; }

    /* ── country bars ── */
    .country-row { margin-bottom: 13px; }
    .country-meta { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .country-name { font-size: 12px; color: #94a3b8; }
    .country-count { font-size: 12px; color: var(--accent); }
    .progress-bg { background: #0a1525; border-radius: 3px; height: 5px; }
    .progress-fill { height: 5px; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .5s ease; }

    /* ── referrer cards ── */
    .ref-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .ref-card {
      background: rgba(56,189,248,.05); border: 1px solid rgba(56,189,248,.1);
      border-radius: 10px; padding: 10px 16px;
    }
    .ref-name { font-size: 11px; color: #64748b; margin-bottom: 4px; }
    .ref-count { font-family: 'Bebas Neue', cursive; font-size: 28px; color: var(--accent); }

    /* ── visit log ── */
    .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .log-scroll { max-height: 340px; overflow-y: auto; }

    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; padding: 5px 10px; font-size: 9px;
      color: var(--dim); letter-spacing: .1em; font-weight: normal;
      border-bottom: 1px solid #0f1e35;
    }
    td { padding: 8px 10px; border-bottom: 1px solid #0c1220; font-size: 11px; }
    .td-num { color: #1a2a40; }
    .td-time { color: var(--accent); font-size: 12px; }
    .td-date { color: var(--muted); }
    .td-ref  { color: var(--muted); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px;
    }
    .badge-country { background: #0a1525; border: 1px solid var(--border); color: #94a3b8; }
    .badge-sim  { background: rgba(99,102,241,.1); border: 1px solid rgba(99,102,241,.2); color: var(--purple); }
    .badge-real { background: rgba(34,197,94,.07); border: 1px solid rgba(34,197,94,.14); color: var(--green); }

    /* ── skeleton ── */
    .sk {
      background: linear-gradient(90deg, #0f1a2e 25%, #162035 50%, #0f1a2e 75%);
      background-size: 400px 100%; animation: shimmer 1.4s infinite linear; border-radius: 8px;
    }
    @keyframes shimmer { 0%{background-position:-400px 0} 100%{background-position:400px 0} }

    /* ── fadeup ── */
    .fade-up { animation: fadeUp .4s ease; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* ── empty window msg ── */
    .no-data { text-align: center; padding: 40px 0; color: #1a2a40; font-size: 13px; }
    .no-data span { color: var(--accent); }

    /* ── auto-refresh note ── */
    .refresh-note { font-size: 10px; color: var(--dim); text-align: right; margin-top: 10px; }

    /* ── install instructions ── */
    .install-box {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 22px 24px; margin-top: 16px;
    }
    .install-title { font-size: 9px; color: var(--dim); letter-spacing: .12em; margin-bottom: 16px; }
    .install-step { margin-bottom: 14px; }
    .install-step-num { font-size: 9px; color: var(--accent); letter-spacing: .1em; margin-bottom: 4px; }
    .install-step-desc { font-size: 12px; color: #94a3b8; margin-bottom: 6px; }
    .code-block {
      background: #060a10; border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 14px; font-size: 11px; color: var(--accent);
      word-break: break-all; position: relative;
    }
    .copy-btn {
      position: absolute; right: 8px; top: 8px;
      cursor: pointer; background: var(--border); border: none; border-radius: 4px;
      color: #64748b; font-size: 10px; padding: 2px 8px;
      font-family: 'IBM Plex Mono', monospace;
    }
    .copy-btn:hover { background: #243050; color: #94a3b8; }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo"><span>GITHUB</span> PROFILE VIEWS</div>
  <div id="live-badge" class="live-badge" style="display:none">
    <div id="pulse-dot" class="pulse-dot"></div>
    <span id="tracking-label">TRACKING · @—</span>
  </div>
  <div id="last-refresh" style="font-size:11px;color:var(--dim);margin-left:auto;display:none">
    Refreshing every 30s
  </div>
</header>

<main>
  <!-- SEARCH -->
  <div class="search-row">
    <div class="search-wrap">
      <span class="search-prefix">github.com /</span>
      <input type="text" id="username-input" placeholder="enter username…" />
    </div>
    <button class="btn btn-primary btn-lg" id="search-btn">View Stats →</button>
  </div>

  <!-- EMPTY STATE -->
  <div id="empty">
    <div class="empty-big" style="color:#0c1830">ENTER A</div>
    <div class="empty-big" style="color:#0f2240">USERNAME</div>
    <div style="margin-top:20px;font-size:12px;color:#1a2a40">
      Type any GitHub username above to see their real-time profile visit stats
    </div>
  </div>

  <!-- DASHBOARD (hidden until search) -->
  <div id="dashboard" style="display:none">

    <!-- TIME WINDOW -->
    <div class="win-row">
      <div class="win-label">TIME WINDOW</div>
      <div class="win-buttons" id="win-buttons">
        <button class="wbtn off" data-win="1h">1 Hour</button>
        <button class="wbtn on"  data-win="1d">1 Day</button>
        <button class="wbtn off" data-win="7d">7 Days</button>
        <button class="wbtn off" data-win="30d">30 Days</button>
        <button class="wbtn off" data-win="1y">1 Year</button>
      </div>
    </div>

    <!-- STAT CARDS -->
    <div class="stat-grid" id="stat-grid">
      <div class="card stat-card"><div class="stat-label">PROFILE VIEWS</div><div class="stat-val" id="s-total">—</div></div>
      <div class="card stat-card"><div class="stat-label">ALL TIME</div><div class="stat-val" id="s-alltime">—</div></div>
      <div class="card stat-card"><div class="stat-label">COUNTRIES</div><div class="stat-val" id="s-countries">—</div></div>
      <div class="card stat-card"><div class="stat-label">TOP SOURCE</div><div class="stat-val" id="s-topsource" style="font-size:20px">—</div></div>
    </div>

    <!-- CHART + COUNTRIES -->
    <div class="two-col">
      <div class="card" style="padding:22px 24px">
        <div class="chart-header">
          <div>
            <div class="chart-title-label">VISIT ACTIVITY</div>
            <div class="chart-subtitle" id="chart-subtitle">— visits</div>
          </div>
          <div class="chart-window-label" id="chart-win-label">1D</div>
        </div>
        <div class="bar-chart" id="bar-chart"></div>
      </div>
      <div class="card" style="padding:22px 20px">
        <div class="stat-label" style="margin-bottom:16px">TOP COUNTRIES</div>
        <div id="countries-list">
          <div class="no-data">No data yet</div>
        </div>
      </div>
    </div>

    <!-- REFERRERS + BADGE SETUP -->
    <div class="two-col">
      <div class="card" style="padding:22px 24px">
        <div class="stat-label" style="margin-bottom:16px">REFERRER SOURCES</div>
        <div class="ref-grid" id="ref-grid">
          <div class="no-data">No referrer data</div>
        </div>
      </div>
      <div class="card" style="padding:22px 20px">
        <div class="stat-label" style="margin-bottom:14px">README BADGE</div>
        <div style="font-size:11px;color:#64748b;margin-bottom:10px;line-height:1.6">
          Add this to your GitHub README to start tracking real visits:
        </div>
        <div class="code-block" id="badge-code" style="font-size:10px">
          <span id="badge-snippet">![](https://your-app.vercel.app/api/track?user=username)</span>
          <button class="copy-btn" onclick="copyBadge()">copy</button>
        </div>
        <div style="margin-top:12px;font-size:10px;color:var(--dim);line-height:1.7">
          Replace <span style="color:var(--accent)">your-app.vercel.app</span> with your Vercel URL after deploying.
        </div>
      </div>
    </div>

    <!-- VISIT LOG -->
    <div class="card" style="padding:22px 24px">
      <div class="log-header">
        <div class="stat-label" id="log-title">VISIT LOG</div>
        <span style="font-size:11px;color:var(--dim)" id="log-count">— entries</span>
      </div>
      <div class="log-scroll">
        <table>
          <thead>
            <tr>
              <th>#</th><th>TIME</th><th>DATE</th><th>COUNTRY</th><th>CITY</th><th>REFERRER</th><th>AGO</th>
            </tr>
          </thead>
          <tbody id="log-body">
            <tr><td colspan="7" class="no-data">No visits recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /dashboard -->
</main>

<script>
  // ── config ──────────────────────────────────────────────────────────────
  // When deployed on Vercel, this auto-detects the base URL.
  // During local dev, it points to localhost:3000
  const API_BASE = window.location.origin;

  // ── state ────────────────────────────────────────────────────────────────
  let currentUser   = null;
  let currentWindow = "1d";
  let refreshTimer  = null;

  const WINDOWS = {
    "1h":  { slots: 12, slotMs: 300_000,       label: i => `-${60 - i * 5}m` },
    "1d":  { slots: 24, slotMs: 3_600_000,     label: i => `-${24 - i}h` },
    "7d":  { slots: 7,  slotMs: 86_400_000,    label: i => { const d = new Date(Date.now() - (7 - i) * 86400000); return d.toLocaleDateString("en-US",{weekday:"short"}); } },
    "30d": { slots: 30, slotMs: 86_400_000,    label: i => { const d = new Date(Date.now() - (30 - i) * 86400000); return `${d.getMonth()+1}/${d.getDate()}`; } },
    "1y":  { slots: 12, slotMs: 2_628_000_000, label: i => { const d = new Date(Date.now() - (12 - i) * 2628000000); return d.toLocaleDateString("en-US",{month:"short"}); } },
  };

  // ── helpers ───────────────────────────────────────────────────────────────
  const fmt = {
    time: ts => new Date(ts).toLocaleTimeString("en-US", { hour:"2-digit", minute:"2-digit", second:"2-digit" }),
    date: ts => new Date(ts).toLocaleDateString("en-US", { month:"short", day:"numeric" }),
    rel:  ts => {
      const d = Date.now() - ts;
      if (d < 60000)    return `${Math.floor(d/1000)}s ago`;
      if (d < 3600000)  return `${Math.floor(d/60000)}m ago`;
      if (d < 86400000) return `${Math.floor(d/3600000)}h ago`;
      return `${Math.floor(d/86400000)}d ago`;
    },
  };

  function $(id) { return document.getElementById(id); }

  function el(tag, attrs = {}, ...children) {
    const e = document.createElement(tag);
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === "class") e.className = v;
      else if (k === "style") e.style.cssText = v;
      else e.setAttribute(k, v);
    });
    children.forEach(c => e.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return e;
  }

  // ── search ────────────────────────────────────────────────────────────────
  function handleSearch() {
    const raw = $("username-input").value.trim().replace(/^@/, "");
    if (!raw) return;
    currentUser = raw;

    $("empty").style.display = "none";
    $("dashboard").style.display = "block";
    $("dashboard").className = "fade-up";

    $("live-badge").style.display = "flex";
    $("tracking-label").textContent = `TRACKING · @${raw}`;
    $("last-refresh").style.display = "block";

    // Update badge snippet
    $("badge-snippet").textContent = `![](${API_BASE}/api/track?user=${raw})`;

    loadStats();
    clearInterval(refreshTimer);
    refreshTimer = setInterval(loadStats, 30_000); // auto-refresh every 30s
  }

  $("search-btn").addEventListener("click", handleSearch);
  $("username-input").addEventListener("keydown", e => e.key === "Enter" && handleSearch());

  // ── window buttons ────────────────────────────────────────────────────────
  document.querySelectorAll(".wbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".wbtn").forEach(b => b.className = "wbtn off");
      btn.className = "wbtn on";
      currentWindow = btn.dataset.win;
      loadStats();
    });
  });

  // ── fetch stats ───────────────────────────────────────────────────────────
  async function loadStats() {
    if (!currentUser) return;

    $("pulse-dot").classList.add("active");

    try {
      const res  = await fetch(`${API_BASE}/api/stats?user=${encodeURIComponent(currentUser)}&window=${currentWindow}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderDashboard(data);
    } catch (err) {
      console.error("Failed to load stats:", err);
    } finally {
      $("pulse-dot").classList.remove("active");
    }
  }

  // ── render ────────────────────────────────────────────────────────────────
  function renderDashboard(data) {
    const { total, allTime, chart, topCountries, topReferrers, log, window: win } = data;
    const winCfg = WINDOWS[win];

    // Stat cards
    $("s-total").textContent    = total.toLocaleString();
    $("s-alltime").textContent  = (allTime || total).toLocaleString();
    $("s-countries").textContent = topCountries.length;

    const topSrc = topReferrers[0]?.ref || "—";
    $("s-topsource").textContent  = topSrc;
    $("s-topsource").className    = "stat-val" + (topSrc.length > 8 ? " small" : "");

    // Chart
    $("chart-subtitle").textContent  = `${total.toLocaleString()} visit${total !== 1 ? "s" : ""} · last ${win}`;
    $("chart-win-label").textContent = win.toUpperCase();

    renderChart(chart, winCfg, win);

    // Countries
    renderCountries(topCountries, total);

    // Referrers
    renderReferrers(topReferrers);

    // Log
    $("log-title").textContent = `VISIT LOG · ${win.toUpperCase()}`;
    $("log-count").textContent = `${log.length} shown`;
    renderLog(log);
  }

  function renderChart(chart, winCfg, win) {
    const max   = Math.max(...chart, 1);
    const dense = chart.length >= 24;
    const container = $("bar-chart");
    container.innerHTML = "";

    chart.forEach((v, i) => {
      const height = Math.max(4, (v / max) * 58);
      const showLabel = !dense || win === "1y" || (win === "30d" && i % 5 === 0) || (win === "1d" && i % 4 === 0) || i === chart.length - 1;

      const fill = el("div", {
        class: "bar-fill",
        style: `height:${height}px;background:${v > 0 ? "linear-gradient(180deg,#38bdf8,#0ea5e9aa)" : "#0f1e35"};border:${v > 0 ? "none" : "1px solid #1a2540"}`
      });
      const lbl = el("span", {
        class: "bar-lbl",
        style: `color:${showLabel ? "var(--dim)" : "transparent"}`
      }, winCfg.label(i));

      const col = el("div", { class: "bar-col" });
      col.appendChild(fill);
      col.appendChild(lbl);
      container.appendChild(col);
    });
  }

  function renderCountries(countries, total) {
    const container = $("countries-list");
    container.innerHTML = "";
    if (!countries.length) {
      container.innerHTML = '<div class="no-data">No visits in this window</div>';
      return;
    }
    countries.forEach(({ country, count }) => {
      const pct = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
      container.innerHTML += `
        <div class="country-row">
          <div class="country-meta">
            <span class="country-name">${country}</span>
            <span class="country-count">${count}</span>
          </div>
          <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
        </div>`;
    });
  }

  function renderReferrers(refs) {
    const container = $("ref-grid");
    container.innerHTML = "";
    if (!refs.length) {
      container.innerHTML = '<div class="no-data">No referrer data</div>';
      return;
    }
    refs.forEach(({ ref, count }) => {
      container.innerHTML += `
        <div class="ref-card">
          <div class="ref-name">${ref}</div>
          <div class="ref-count">${count}</div>
        </div>`;
    });
  }

  function renderLog(log) {
    const body = $("log-body");
    if (!log.length) {
      body.innerHTML = '<tr><td colspan="7" class="no-data">No visits in this window</td></tr>';
      return;
    }
    body.innerHTML = log.map((v, i) => `
      <tr>
        <td class="td-num">${log.length - i}</td>
        <td class="td-time">${fmt.time(v.ts)}</td>
        <td class="td-date">${fmt.date(v.ts)}</td>
        <td><span class="badge badge-country">${v.country || "??"}</span></td>
        <td class="td-date" style="font-size:10px">${v.city || "—"}</td>
        <td class="td-ref">${v.ref || "direct"}</td>
        <td style="color:var(--dim)">${fmt.rel(v.ts)}</td>
      </tr>`).join("");
  }

  // ── copy badge ────────────────────────────────────────────────────────────
  function copyBadge() {
    const text = $("badge-snippet").textContent;
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.querySelector(".copy-btn");
      btn.textContent = "✓ copied";
      setTimeout(() => btn.textContent = "copy", 2000);
    });
  }
</script>
</body>
</html>
